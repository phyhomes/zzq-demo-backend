<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zzq.system.mapper.SysRoleMapper">
    <resultMap id="SysRoleResult" type="SysRole">
        <id property="id" column="role_id"/>
        <result property="roleName" column="role_name"/>
        <result property="roleKey" column="role_key"/>
        <result property="seq" column="seq"/>
        <result property="dataScope" column="data_scope"/>
        <result property="menuAssociateFlag" column="menu_associate_flag"/>
        <result property="deptAssociateFlag" column="dept_associate_flag"/>
        <result property="status" column="status"/>
        <result property="remark" column="remark"/>
    </resultMap>

    <resultMap id="SysRoleDTOResult" type="com.zzq.framework.domain.dto.SysRoleDTO" extends="SysRoleResult">
        <collection property="deptIds" ofType="Long" column="role_id" select="selectDeptIdsByRoleId" />
        <collection property="permissions" ofType="String" javaType="java.util.Set" select="selectPermissionsByRoleId" column="role_id"/>
        <collection property="menuIds" ofType="java.lang.Long" select="selectMenuIdsByRoleId" column="role_id"/>
    </resultMap>



    <sql id="roleVo">
        select r.id role_id, r.role_name, r.role_key, r.seq,
               r.data_scope, r.menu_associate_flag, r.dept_associate_flag, r.status, r.remark
    </sql>
    <select id="selectRoleKeysByUserId" resultType="String" parameterType="Long">
        select distinct r.role_key
        from sys_role r
        left join sys_user_role ur on r.id = ur.role_id
        where ur.user_id = #{id} and r.del_flag = 0 and r.status = 1
    </select>
    <select id="selectRoleIdsByUserId" parameterType="Long" resultType="java.lang.Long">
        select r.id
        from sys_role r
        left join sys_user_role ur on r.id = ur.role_id
        where ur.user_id = #{id} and r.del_flag = 0 and r.status = 1
    </select>
    <select id="selectPermissionsByRoleIds" resultType="java.lang.String">
        select distinct m.perms
        from sys_menu m
        left join sys_role_menu rm on m.id = rm.menu_id
        where rm.role_id in
        <foreach item="roleId" collection="roleIds" separator="," open="(" close=")" index="index">
            #{roleId}
        </foreach>
        and m.status = 1
        and m.perms is not null
        and m.type in ("C", "F")
    </select>


</mapper>